# VideoConverter 技術コンテキスト

## 開発環境

VideoConverter は、以下の開発環境で構築されています：

- **オペレーティングシステム**: Windows 11（主要対象）
- **Python バージョン**: Python 3.11
- **仮想環境**: venv（`.venv` ディレクトリに作成）
- **パッケージ管理**: pip
- **コード品質ツール**: black（フォーマッター）、isort（インポート整理）
- **テストフレームワーク**: unittest（標準ライブラリ）

## 依存関係

### 外部依存

- **FFmpeg**: 動画処理エンジン（システムにインストールされている必要あり）
  - Windows では `winget install ffmpeg` でインストール可能
  - システム環境変数 `PATH` に FFmpeg の実行ファイルのパスが登録されている必要あり

### Python パッケージ依存

以下のパッケージが `pyproject.toml` で定義されています：

- **ffmpeg-python**: FFmpeg の Python バインディング
- **fire**: コマンドラインインターフェース構築ライブラリ
- **tqdm**: コマンドラインプログレスバーライブラリ
- **psutil**: システムリソース情報取得ライブラリ
- **gevent**: 非同期処理ライブラリ
- **pyinstaller**: 実行可能ファイル作成ツール
- **black**: コードフォーマッター
- **isort**: インポート整理ツール

## インストール手順

### 開発環境のセットアップ

```powershell
# FFmpeg のインストール
winget install ffmpeg

# 仮想環境の作成
py -3.11 -m venv .venv

# 仮想環境のアクティブ化
.\.venv\Scripts\Activate.ps1

# pip のアップグレード
python -m pip install --upgrade pip

# パッケージのインストール
pip install -e .
```

### GUI 実行ファイルの作成

```powershell
pyinstaller .\video_converter\gui.py --onefile --noconsole
```

### テストの実行

```powershell
# 仮想環境のアクティブ化
.\.venv\Scripts\Activate.ps1

# すべてのテストを実行
python tests/run_tests.py
```

## 技術的制約

1. **FFmpeg 依存**: システムに FFmpeg がインストールされている必要があり、環境変数 `PATH` に登録されている必要があります。
2. **TCP ポート**: 進捗情報の受信には TCP ポートを使用するため、ファイアウォールの設定によっては問題が発生する可能性があります。
3. **非同期処理**: `gevent` を使用した非同期処理を行っているため、`monkey.patch_all()` を呼び出して標準ライブラリの関数を `gevent` 互換のものに置き換える必要があります。
4. **テスト環境**: テストを実行するには、テスト用の動画ファイル（`tests/car-detection.mp4`）が必要です。

## パフォーマンス考慮事項

1. **メモリ使用量**: 大きな動画ファイルを処理する場合、メモリ使用量が増加する可能性があります。
2. **CPU 使用率**: FFmpeg の処理は CPU 負荷が高いため、他のアプリケーションのパフォーマンスに影響を与える可能性があります。
3. **ディスク容量**: 変換・圧縮処理の結果、新しいファイルが作成されるため、十分なディスク容量が必要です。
4. **テスト実行時間**: テストでは実際に動画処理を行うため、テストの実行に時間がかかる可能性があります。

## セキュリティ考慮事項

1. **ファイルアクセス**: ユーザーが指定したファイルにアクセスするため、適切なファイルアクセス権限が必要です。
2. **TCP 通信**: 進捗情報の受信には TCP 通信を使用していますが、ローカルホスト（127.0.0.1）のみにバインドしているため、外部からのアクセスはできません。
3. **テストデータ**: テストでは、テスト用の動画ファイルを使用します。このファイルは、著作権やプライバシーの問題がないものを使用する必要があります。

## 将来の拡張性

1. **追加の変換オプション**: 現在は基本的な変換・圧縮・抽出・削除機能のみをサポートしていますが、将来的には解像度変更、フレームレート変更、トリミングなどの機能を追加できます。
2. **バッチ処理**: 複数のファイルを一度に処理する機能を追加できます。
3. **プリセット**: 一般的な使用シナリオに対応したプリセットを追加できます。
4. **プラグイン機構**: 新しい機能を簡単に追加できるプラグイン機構を実装できます。
5. **テストの拡張**: 現在は基本的な機能のテストのみを実装していますが、将来的にはエラーケースのテストやパフォーマンステストなどを追加できます。
